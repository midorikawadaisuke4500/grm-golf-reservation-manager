<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GRM Fast - Golf Reservation Manager</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0d1117;
            color: #f0f6fc;
            min-height: 100vh;
            padding-bottom: 70px;
        }

        .header {
            background: linear-gradient(135deg, #238636 0%, #1a7f37 100%);
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header p {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 16px;
        }

        .stat {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.green {
            color: #3fb950;
        }

        .stat-value.yellow {
            color: #d29922;
        }

        .stat-value.red {
            color: #f85149;
        }

        .stat-label {
            font-size: 0.625rem;
            color: #8b949e;
            margin-top: 2px;
        }

        .section {
            padding: 0 16px 16px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .date {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .weekday {
            display: inline-block;
            background: #238636;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .badge {
            font-size: 0.625rem;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .badge-pending {
            background: rgba(210, 153, 34, 0.2);
            color: #d29922;
        }

        .badge-confirmed {
            background: rgba(63, 185, 80, 0.2);
            color: #3fb950;
        }

        .info {
            display: flex;
            gap: 16px;
            color: #8b949e;
            font-size: 0.875rem;
        }

        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
        }

        .btn-all {
            padding: 6px 12px;
            font-size: 0.625rem;
        }

        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #161b22;
            border-top: 1px solid #30363d;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
        }

        .nav-item {
            background: none;
            border: none;
            color: #8b949e;
            font-size: 0.625rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .nav-item.active {
            color: #3fb950;
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        .loading {
            color: #8b949e;
            font-size: 0.75rem;
            text-align: center;
            padding: 8px;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        #content {
            min-height: 200px;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>â›³ Golf Manager</h1>
        <p>éº»å€‰ã‚´ãƒ«ãƒ•å€¶æ¥½éƒ¨</p>
    </div>

    <div class="stats" id="stats">
        <div class="stat">
            <div class="stat-value green" id="statUpcoming">-</div>
            <div class="stat-label">äºˆç´„</div>
        </div>
        <div class="stat">
            <div class="stat-value green" id="statConfirmed">-</div>
            <div class="stat-label">ç¢ºå®š</div>
        </div>
        <div class="stat">
            <div class="stat-value yellow" id="statPending">-</div>
            <div class="stat-label">å¾…ã¡</div>
        </div>
        <div class="stat">
            <div class="stat-value red" id="statReminder">-</div>
            <div class="stat-label">è¦ç¢ºèª</div>
        </div>
    </div>

    <div id="content">
        <div class="loading">ğŸ“¡ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="showView('home')"><span class="nav-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
        <button class="nav-item" onclick="showView('calendar')"><span class="nav-icon">ğŸ“…</span>äºˆç´„</button>
        <button class="nav-item" onclick="showView('merge')"><span class="nav-icon">ğŸ”€</span>ãƒãƒ¼ã‚¸</button>
        <button class="nav-item" onclick="showView('settings')"><span class="nav-icon">âš™ï¸</span>è¨­å®š</button>
    </nav>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbzk0MBU_pTE2Gtd4wsGOPop2HgcdUlH4Pa9kxmHdkKZrvO_QKhQXxGwIBAdEw4CWqXh/exec';
        let data = { stats: {}, reservations: [] };
        let currentView = 'home';

        // å³åº§ã«UIã‚’è¡¨ç¤ºï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            showView('home');
            loadData();
        });

        async function loadData() {
            try {
                const res = await fetch(API + '?action=getInitialData');
                data = await res.json();
                updateStats();
                showView(currentView);
            } catch (e) {
                console.error('Load failed:', e);
            }
        }

        function updateStats() {
            const s = data.stats || {};
            document.getElementById('statUpcoming').textContent = s.upcoming || 0;
            document.getElementById('statConfirmed').textContent = s.confirmed || 0;
            document.getElementById('statPending').textContent = s.pending || 0;
            document.getElementById('statReminder').textContent = s.needsReminder || 0;
        }

        function showView(view) {
            currentView = view;
            document.querySelectorAll('.nav-item').forEach((n, i) => {
                n.classList.toggle('active', ['home', 'calendar', 'merge', 'settings'][i] === view);
            });
            const content = document.getElementById('content');

            if (view === 'home') {
                content.innerHTML = `
                    <div class="section">
                        <h2 class="section-title">ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h2>
                        <div class="card">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="color:#8b949e;">æ¥ç¶š</span>
                                <span class="badge badge-confirmed">GAS ãƒ©ã‚¤ãƒ–</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                                <span style="color:#8b949e;">UI</span>
                                <span>é«˜é€Ÿç‰ˆ v2</span>
                            </div>
                        </div>
                    </div>`;
            } else if (view === 'calendar') {
                const reservations = data.reservations || [];
                const pending = reservations.filter(r => r.status === 'pending');
                const confirmed = reservations.filter(r => r.status === 'confirmed');

                let html = '<div class="section">';

                if (pending.length > 0) {
                    html += `<h2 class="section-title" style="color:#d29922;">â³ æ‰¿èªå¾…ã¡ (${pending.length}ä»¶)
                        <button type="button" class="btn btn-all" onclick="approveAll()">âœ… ä¸€æ‹¬æ‰¿èª</button>
                    </h2>`;
                    pending.forEach(r => { html += renderCard(r, 'pending'); });
                }

                if (confirmed.length > 0) {
                    html += `<h2 class="section-title" style="color:#3fb950;margin-top:16px;">âœ… ç¢ºå®šæ¸ˆã¿ (${confirmed.length}ä»¶)</h2>`;
                    confirmed.forEach(r => { html += renderCard(r, 'confirmed'); });
                }

                if (reservations.length === 0) {
                    html += '<div class="empty">ğŸ“… äºˆç´„ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
                }

                html += '</div>';
                content.innerHTML = html;
            } else if (view === 'merge') {
                content.innerHTML = '<div class="loading">ğŸ”„ ãƒãƒ¼ã‚¸å€™è£œã‚’å–å¾—ä¸­...</div>';
                loadMergeCandidates();
            } else if (view === 'settings') {
                const mode = data.settings?.mode || 'hybrid';
                content.innerHTML = `
                    <div class="section">
                        <h2 class="section-title">è¨­å®š</h2>
                        <div class="card">
                            <div style="margin-bottom:12px;">
                                <span style="color:#8b949e;">UIãƒãƒ¼ã‚¸ãƒ§ãƒ³</span>
                                <p style="margin-top:4px;">é«˜é€Ÿç‰ˆ v2</p>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top:12px;">
                            <div style="margin-bottom:12px;">
                                <span style="color:#8b949e;">é€šçŸ¥ãƒ¢ãƒ¼ãƒ‰</span>
                                <p style="margin-top:4px;font-size:0.75rem;">ç¾åœ¨: ${mode === 'web_only' ? 'Webã®ã¿' : 'LINE + Web'}</p>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn" style="flex:1;${mode !== 'web_only' ? 'opacity:0.5;' : ''}" onclick="setNotificationMode('web_only')">
                                    ğŸ“± Webã®ã¿
                                </button>
                                <button class="btn" style="flex:1;${mode !== 'hybrid' ? 'opacity:0.5;' : ''}" onclick="setNotificationMode('hybrid')">
                                    ğŸ”” LINE+Web
                                </button>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top:12px;">
                            <button class="btn" style="width:100%;" onclick="location.href='index.html'">ğŸ“± é€šå¸¸ç‰ˆUIã«åˆ‡æ›¿</button>
                        </div>
                    </div>`;
            }
        }

        function renderCard(r, status) {
            let year = '', month = '', day = '';
            if (typeof r.date === 'string' && r.date.match(/^\d{4}-\d{2}-\d{2}/)) {
                const parts = r.date.split('-');
                year = parts[0]; month = parseInt(parts[1]); day = parseInt(parts[2]);
            } else {
                const d = new Date(r.date);
                year = d.getFullYear(); month = d.getMonth() + 1; day = d.getDate();
            }
            const weekday = r.weekday || ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][new Date(r.date).getDay()];
            const time = r.time || '--:--';
            const course = r.course || 'OUT';
            const badgeClass = status === 'pending' ? 'badge-pending' : 'badge-confirmed';
            const badgeText = status === 'pending' ? 'æ‰¿èªå¾…ã¡' : 'ç¢ºå®šæ¸ˆã¿';
            const btn = status === 'pending' ? `<button type="button" class="btn" id="btn-${r.id}" onclick="approve('${r.id}', this)">âœ… æ‰¿èª</button>` : '';

            return `
                <div class="card">
                    <div class="card-header">
                        <div><span class="date">${year}/${month}/${day}</span><span class="weekday">${weekday}</span></div>
                        <span class="badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="info">
                        <span>ğŸ• ${time}</span>
                        <span>ğŸ“ ${course}ã‚³ãƒ¼ã‚¹</span>
                    </div>
                    ${btn}
                </div>`;
        }

        async function approve(id, btn) {
            if (!id) return alert('âŒ IDä¸æ­£');
            btn.disabled = true;
            btn.textContent = 'å‡¦ç†ä¸­...';
            try {
                const res = await fetch(API + '?action=approveReservation&id=' + id);
                const result = await res.json();
                if (result.success) {
                    alert('âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã—ã¾ã—ãŸ');
                    await loadData();
                } else {
                    alert('âŒ å¤±æ•—: ' + (result.error || ''));
                    btn.disabled = false;
                    btn.textContent = 'âœ… æ‰¿èª';
                }
            } catch (e) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message);
                btn.disabled = false;
                btn.textContent = 'âœ… æ‰¿èª';
            }
        }

        async function approveAll() {
            if (!confirm('å…¨ã¦æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const res = await fetch(API + '?action=approveAllReservations');
                const result = await res.json();
                if (result.success) {
                    alert('âœ… ' + result.count + 'ä»¶ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
                    await loadData();
                } else {
                    alert('âŒ å¤±æ•—: ' + (result.error || ''));
                }
            } catch (e) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼');
            }
        }

        async function setNotificationMode(mode) {
            try {
                const res = await fetch(API + '?action=setNotificationMode&mode=' + mode);
                const result = await res.json();
                if (result.success) {
                    alert('âœ… é€šçŸ¥ãƒ¢ãƒ¼ãƒ‰ã‚’ã€Œ' + (mode === 'web_only' ? 'Webã®ã¿' : 'LINE+Web') + 'ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ');
                    await loadData();
                    showView('settings');
                } else {
                    alert('âŒ å¤‰æ›´å¤±æ•—: ' + (result.error || ''));
                }
            } catch (e) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // ========================================
        // ãƒãƒ¼ã‚¸æ©Ÿèƒ½
        // ========================================
        let mergeData = { candidates: [], history: [] };

        async function loadMergeCandidates() {
            try {
                const res = await fetch(API + '?action=getMergeCandidates');
                mergeData = await res.json();
                renderMergeView();
            } catch (e) {
                document.getElementById('content').innerHTML = '<div class="empty">âŒ ãƒãƒ¼ã‚¸å€™è£œã®å–å¾—ã«å¤±æ•—</div>';
            }
        }

        function renderMergeView() {
            const candidates = mergeData.candidates || [];
            const history = mergeData.history || [];
            let html = '<div class="section">';

            // ã‚¹ã‚¿ãƒƒãƒ„
            html += `
                <div class="stats" style="padding:0;margin-bottom:16px;">
                    <div class="stat" style="grid-column: span 2;">
                        <div class="stat-value yellow">${candidates.length}</div>
                        <div class="stat-label">ãƒãƒ¼ã‚¸å¾…ã¡</div>
                    </div>
                    <div class="stat" style="grid-column: span 2;">
                        <div class="stat-value green">${history.length}</div>
                        <div class="stat-label">ãƒãƒ¼ã‚¸æ¸ˆã¿</div>
                    </div>
                </div>`;

            // ãƒãƒ¼ã‚¸å¾…ã¡
            if (candidates.length > 0) {
                html += `<h2 class="section-title" style="color:#d29922;">âš¡ ãƒãƒ¼ã‚¸å¾…ã¡ (${candidates.length}ä»¶)
                    ${candidates.length > 1 ? '<button type="button" class="btn btn-all" onclick="mergeAll()">âœ… ä¸€æ‹¬ãƒãƒ¼ã‚¸</button>' : ''}
                </h2>`;
                candidates.forEach(m => { html += renderMergeCard(m); });
            } else {
                html += `
                    <div class="empty">
                        <div style="font-size:48px;margin-bottom:8px;">âœ…</div>
                        <p>ãƒãƒ¼ã‚¸å¾…ã¡ãªã—</p>
                        <p style="font-size:0.75rem;color:#8b949e;">ã™ã¹ã¦ã®äºˆå®šãŒãƒãƒ¼ã‚¸æ¸ˆã¿ã§ã™</p>
                    </div>`;
            }

            // ãƒãƒ¼ã‚¸å±¥æ­´
            if (history.length > 0) {
                html += `<h2 class="section-title" style="color:#8b949e;margin-top:20px;">ğŸ“‹ ãƒãƒ¼ã‚¸å±¥æ­´</h2>`;
                history.slice(0, 5).forEach(h => {
                    html += `
                        <div class="card" style="padding:12px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div>
                                    <div style="font-weight:600;font-size:0.875rem;">${h.parentTitle || 'è¦ªäºˆå®š'}</div>
                                    <div style="font-size:0.625rem;color:#8b949e;">${h.date} â€¢ ã‚¹ã‚³ã‚¢: ${h.score}</div>
                                </div>
                                <span class="badge badge-confirmed">æ¸ˆ</span>
                            </div>
                        </div>`;
                });
            }

            html += '</div>';
            document.getElementById('content').innerHTML = html;
        }

        function renderMergeCard(merge) {
            const parent = merge.parent || {};
            const children = merge.children || [];
            return `
                <div class="card">
                    <div class="card-header">
                        <span class="date">${merge.date}</span>
                        <span class="badge badge-pending">${children.length}ä»¶ã®å­äºˆå®š</span>
                    </div>
                    
                    <div style="background:#0d1117;border-radius:6px;padding:10px;border-left:3px solid #238636;margin-bottom:6px;">
                        <div style="font-size:0.625rem;color:#238636;font-weight:700;">è¦ª</div>
                        <div style="font-size:0.875rem;font-weight:600;">${parent.title || 'è¦ªäºˆå®š'}</div>
                        <div style="font-size:0.625rem;color:#8b949e;">${parent.time || ''}</div>
                    </div>
                    
                    <div style="text-align:center;color:#8b949e;font-size:0.75rem;padding:4px 0;">â¬‡ï¸ ãƒãƒ¼ã‚¸</div>
                    
                    ${children.map(child => `
                        <div style="background:#0d1117;border-radius:6px;padding:10px;border-left:3px solid #d29922;margin-bottom:6px;">
                            <div style="font-size:0.625rem;color:#d29922;font-weight:700;">å­</div>
                            <div style="font-size:0.875rem;font-weight:600;">${child.title || 'å­äºˆå®š'}</div>
                            <div style="font-size:0.625rem;color:#8b949e;">${child.time || ''}</div>
                        </div>
                    `).join('')}
                    
                    <button type="button" class="btn" style="width:100%;margin-top:8px;" onclick="executeMerge('${merge.date}')">âœ… ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ</button>
                </div>`;
        }

        async function executeMerge(date) {
            if (!confirm('ã“ã®æ—¥ä»˜ã®äºˆå®šã‚’ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const res = await fetch(API + '?action=executeMerge&date=' + encodeURIComponent(date));
                const result = await res.json();
                if (result.success) {
                    alert('âœ… ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ');
                    loadMergeCandidates();
                } else {
                    alert('âŒ ãƒãƒ¼ã‚¸ã«å¤±æ•—: ' + (result.error || ''));
                }
            } catch (e) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        async function mergeAll() {
            const count = mergeData.candidates.length;
            if (!confirm(count + 'ä»¶ã®ãƒãƒ¼ã‚¸å¾…ã¡ã‚’ã™ã¹ã¦ãƒãƒ¼ã‚¸ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                const res = await fetch(API + '?action=executeMergeAll');
                const result = await res.json();
                if (result.success) {
                    alert('âœ… ' + (result.count || count) + 'ä»¶ã®ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ');
                    loadMergeCandidates();
                } else {
                    alert('âŒ ãƒãƒ¼ã‚¸ã«å¤±æ•—: ' + (result.error || ''));
                }
            } catch (e) {
                alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }
    </script>
</body>

</html>